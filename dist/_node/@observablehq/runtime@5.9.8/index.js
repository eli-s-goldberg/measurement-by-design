import{Inspector as xt}from"../inspector@5.0.0/index.js";import{Library as M,FileAttachments as R}from"../stdlib@5.8.7/index.js";import{Library as kt}from"../stdlib@5.8.7/index.js";class c extends Error{constructor(e,i){super(e),this.input=i}}c.prototype.name="RuntimeError";function T(t){return t&&typeof t.next=="function"&&typeof t.return=="function"}function g(t){return()=>t}function m(t){return t}function F(t){return()=>{throw t}}const L=Array.prototype,q=L.map;function f(){}const y=1,p=2,b=3,v=Symbol("no-observer");function h(t,e,i,u){i||(i=v),Object.defineProperties(this,{_observer:{value:i,writable:!0},_definition:{value:E,writable:!0},_duplicate:{value:void 0,writable:!0},_duplicates:{value:void 0,writable:!0},_indegree:{value:NaN,writable:!0},_inputs:{value:[],writable:!0},_invalidate:{value:f,writable:!0},_module:{value:e},_name:{value:null,writable:!0},_outputs:{value:new Set,writable:!0},_promise:{value:Promise.resolve(void 0),writable:!0},_reachable:{value:i!==v,writable:!0},_rejector:{value:B(this)},_shadow:{value:C(e,u)},_type:{value:t},_value:{value:void 0,writable:!0},_version:{value:0,writable:!0}})}Object.defineProperties(h.prototype,{_pending:{value:K,writable:!0,configurable:!0},_fulfilled:{value:Q,writable:!0,configurable:!0},_rejected:{value:U,writable:!0,configurable:!0},_resolve:{value:G,writable:!0,configurable:!0},define:{value:D,writable:!0,configurable:!0},delete:{value:J,writable:!0,configurable:!0},import:{value:H,writable:!0,configurable:!0}});function C(t,e){return e?.shadow?new Map(Object.entries(e.shadow).map(([i,u])=>[i,new h(p,t).define([],u)])):null}function V(t){t._module._runtime._dirty.add(t),t._outputs.add(this)}function Y(t){t._module._runtime._dirty.add(t),t._outputs.delete(this)}function E(){throw E}function d(){throw d}function B(t){return e=>{throw e===d?e:e===E?new c(`${t._name} is not defined`,t._name):e instanceof Error&&e.message?new c(e.message,t._name):new c(`${t._name} could not be resolved`,t._name)}}function N(t){return()=>{throw new c(`${t} is defined more than once`)}}function D(t,e,i){switch(arguments.length){case 1:{i=t,t=e=null;break}case 2:{i=e,typeof t=="string"?e=null:(e=t,t=null);break}}return $.call(this,t==null?null:String(t),e==null?[]:q.call(e,this._resolve,this),typeof i=="function"?i:g(i))}function G(t){return this._shadow?.get(t)??this._module._resolve(t)}function $(t,e,i){const u=this._module._scope,l=this._module._runtime;if(this._inputs.forEach(Y,this),e.forEach(V,this),this._inputs=e,this._definition=i,this._value=void 0,i===f?l._variables.delete(this):l._variables.add(this),t!==this._name||u.get(t)!==this){let r,o;if(this._name)if(this._outputs.size)u.delete(this._name),o=this._module._resolve(this._name),o._outputs=this._outputs,this._outputs=new Set,o._outputs.forEach(function(n){n._inputs[n._inputs.indexOf(this)]=o},this),o._outputs.forEach(l._updates.add,l._updates),l._dirty.add(o).add(this),u.set(this._name,o);else if((o=u.get(this._name))===this)u.delete(this._name);else if(o._type===b)o._duplicates.delete(this),this._duplicate=void 0,o._duplicates.size===1&&(o=o._duplicates.keys().next().value,r=u.get(this._name),o._outputs=r._outputs,r._outputs=new Set,o._outputs.forEach(function(n){n._inputs[n._inputs.indexOf(r)]=o}),o._definition=o._duplicate,o._duplicate=void 0,l._dirty.add(r).add(o),l._updates.add(o),u.set(this._name,o));else throw new Error;if(this._outputs.size)throw new Error;t&&((o=u.get(t))?o._type===b?(this._definition=N(t),this._duplicate=i,o._duplicates.add(this)):o._type===p?(this._outputs=o._outputs,o._outputs=new Set,this._outputs.forEach(function(n){n._inputs[n._inputs.indexOf(o)]=this},this),l._dirty.add(o).add(this),u.set(t,this)):(o._duplicate=o._definition,this._duplicate=i,r=new h(b,this._module),r._name=t,r._definition=this._definition=o._definition=N(t),r._outputs=o._outputs,o._outputs=new Set,r._outputs.forEach(function(n){n._inputs[n._inputs.indexOf(o)]=r}),r._duplicates=new Set([this,o]),l._dirty.add(o).add(r),l._updates.add(o).add(r),u.set(t,r)):u.set(t,this)),this._name=t}return this._version>0&&++this._version,l._updates.add(this),l._compute(),this}function H(t,e,i){return arguments.length<3&&(i=e,e=t),$.call(this,String(e),[i._resolve(String(t))],m)}function J(){return $.call(this,null,[],f)}function K(){this._observer.pending&&this._observer.pending()}function Q(t){this._observer.fulfilled&&this._observer.fulfilled(t,this._name)}function U(t){this._observer.rejected&&this._observer.rejected(t,this._name)}const k=Symbol("variable"),A=Symbol("invalidation"),I=Symbol("visibility");function w(t,e=[]){Object.defineProperties(this,{_runtime:{value:t},_scope:{value:new Map},_builtins:{value:new Map([["@variable",k],["invalidation",A],["visibility",I],...e])},_source:{value:null,writable:!0}})}Object.defineProperties(w.prototype,{_resolve:{value:nt,writable:!0,configurable:!0},redefine:{value:W,writable:!0,configurable:!0},define:{value:X,writable:!0,configurable:!0},derive:{value:it,writable:!0,configurable:!0},import:{value:Z,writable:!0,configurable:!0},value:{value:et,writable:!0,configurable:!0},variable:{value:tt,writable:!0,configurable:!0},builtin:{value:ot,writable:!0,configurable:!0}});function W(t){const e=this._scope.get(t);if(!e)throw new c(`${t} is not defined`);if(e._type===b)throw new c(`${t} is defined more than once`);return e.define.apply(e,arguments)}function X(){const t=new h(y,this);return t.define.apply(t,arguments)}function Z(){const t=new h(y,this);return t.import.apply(t,arguments)}function tt(t,e){return new h(y,this,t,e)}async function et(t){let e=this._scope.get(t);if(!e)throw new c(`${t} is not defined`);if(e._observer===v){e=this.variable(!0).define([t],m);try{return await S(this._runtime,e)}finally{e.delete()}}else return S(this._runtime,e)}async function S(t,e){await t._compute();try{return await e._promise}catch(i){if(i===d)return S(t,e);throw i}}function it(t,e){const i=new Map,u=new Set,l=[];function r(n){let s=i.get(n);return s||(s=new w(n._runtime,n._builtins),s._source=n,i.set(n,s),l.push([s,n]),u.add(n),s)}const o=r(this);for(const n of t){const{alias:s,name:a}=typeof n=="object"?n:{name:n};o.import(a,s??a,e)}for(const n of u)for(const[s,a]of n._scope)if(a._definition===m){if(n===this&&o._scope.has(s))continue;const _=a._inputs[0]._module;_._source&&r(_)}for(const[n,s]of l)for(const[a,_]of s._scope){const P=n._scope.get(a);if(!(P&&P._type!==p))if(_._definition===m){const O=_._inputs[0],x=O._module;n.import(O._name,a,i.get(x)||x)}else n.define(a,_._inputs.map(rt),_._definition)}return o}function nt(t){let e=this._scope.get(t),i;if(!e)if(e=new h(p,this),this._builtins.has(t))e.define(t,g(this._builtins.get(t)));else if(this._runtime._builtin._scope.has(t))e.import(t,this._runtime._builtin);else{try{i=this._runtime._global(t)}catch(u){return e.define(t,F(u))}i===void 0?this._scope.set(e._name=t,e):e.define(t,g(i))}return e}function ot(t,e){this._builtins.set(t,e)}function rt(t){return t._name}const ut=typeof requestAnimationFrame=="function"?requestAnimationFrame:typeof setImmediate=="function"?setImmediate:t=>setTimeout(t,0);function z(t=new M,e=St){const i=this.module();if(Object.defineProperties(this,{_dirty:{value:new Set},_updates:{value:new Set},_precomputes:{value:[],writable:!0},_computing:{value:null,writable:!0},_init:{value:null,writable:!0},_modules:{value:new Map},_variables:{value:new Set},_disposed:{value:!1,writable:!0},_builtin:{value:i},_global:{value:e}}),t)for(const u in t)new h(p,i).define(u,[],t[u])}Object.defineProperties(z.prototype,{_precompute:{value:lt,writable:!0,configurable:!0},_compute:{value:_t,writable:!0,configurable:!0},_computeSoon:{value:ct,writable:!0,configurable:!0},_computeNow:{value:ft,writable:!0,configurable:!0},dispose:{value:st,writable:!0,configurable:!0},module:{value:at,writable:!0,configurable:!0},fileAttachments:{value:R,writable:!0,configurable:!0}});function st(){this._computing=Promise.resolve(),this._disposed=!0,this._variables.forEach(t=>{t._invalidate(),t._version=NaN})}function at(t,e=f){let i;if(t===void 0)return(i=this._init)?(this._init=null,i):new w(this);if(i=this._modules.get(t),i)return i;this._init=i=new w(this),this._modules.set(t,i);try{t(this,e)}finally{this._init=null}return i}function lt(t){this._precomputes.push(t),this._compute()}function _t(){return this._computing||(this._computing=this._computeSoon())}function ct(){return new Promise(ut).then(()=>this._disposed?void 0:this._computeNow())}async function ft(){let t=[],e,i,u=this._precomputes;if(u.length){this._precomputes=[];for(const r of u)r();await dt(3)}e=new Set(this._dirty),e.forEach(function(r){r._inputs.forEach(e.add,e);const o=$t(r);o>r._reachable?this._updates.add(r):o<r._reachable&&r._invalidate(),r._reachable=o},this),e=new Set(this._updates),e.forEach(function(r){r._reachable?(r._indegree=0,r._outputs.forEach(e.add,e)):(r._indegree=NaN,e.delete(r))}),this._computing=null,this._updates.clear(),this._dirty.clear(),e.forEach(function(r){r._outputs.forEach(pt)});do{for(e.forEach(function(r){r._indegree===0&&t.push(r)});i=t.pop();)wt(i),i._outputs.forEach(l),e.delete(i);e.forEach(function(r){ht(r)&&(yt(r,new c("circular definition")),r._outputs.forEach(vt),e.delete(r))})}while(e.size);function l(r){--r._indegree===0&&t.push(r)}}function dt(t=0){let e=Promise.resolve();for(let i=0;i<t;++i)e=e.then(()=>{});return e}function ht(t){const e=new Set(t._inputs);for(const i of e){if(i===t)return!0;i._inputs.forEach(e.add,e)}return!1}function pt(t){++t._indegree}function vt(t){--t._indegree}function mt(t){return t._promise.catch(t._rejector)}function j(t){return new Promise(function(e){t._invalidate=e})}function bt(t,e){let i=typeof IntersectionObserver=="function"&&e._observer&&e._observer._node,u=!i,l=f,r=f,o,n;return i&&(n=new IntersectionObserver(([s])=>(u=s.isIntersecting)&&(o=null,l())),n.observe(i),t.then(()=>(n.disconnect(),n=null,r()))),function(s){return u?Promise.resolve(s):n?(o||(o=new Promise((a,_)=>(l=a,r=_))),o.then(()=>s)):Promise.reject()}}function wt(t){t._invalidate(),t._invalidate=f,t._pending();const e=t._value,i=++t._version;let u=null;const l=t._promise=(t._inputs.length?Promise.all(t._inputs.map(mt)).then(r):new Promise(n=>n(t._definition.call(e)))).then(o);function r(n){if(t._version!==i)throw d;for(let s=0,a=n.length;s<a;++s)switch(n[s]){case A:{n[s]=u=j(t);break}case I:{u||(u=j(t)),n[s]=bt(u,t);break}case k:{n[s]=t;break}}return t._definition.apply(e,n)}function o(n){if(t._version!==i)throw d;return T(n)?((u||j(t)).then(Et(n)),gt(t,i,n)):n}l.then(n=>{t._value=n,t._fulfilled(n)},n=>{n===d||t._version!==i||(t._value=void 0,t._rejected(n))})}function gt(t,e,i){const u=t._module._runtime;let l;function r(s){return new Promise(a=>a(i.next(l))).then(({done:a,value:_})=>a?void 0:Promise.resolve(_).then(s))}function o(){const s=r(a=>{if(t._version!==e)throw d;return l=a,n(a,s).then(()=>u._precompute(o)),t._fulfilled(a),a});s.catch(a=>{a===d||t._version!==e||(n(void 0,s),t._rejected(a))})}function n(s,a){return t._value=s,t._promise=a,t._outputs.forEach(u._updates.add,u._updates),u._compute()}return r(s=>{if(t._version!==e)throw d;return l=s,u._precompute(o),s})}function yt(t,e){t._invalidate(),t._invalidate=f,t._pending(),++t._version,t._indegree=NaN,(t._promise=Promise.reject(e)).catch(f),t._value=void 0,t._rejected(e)}function Et(t){return function(){t.return()}}function $t(t){if(t._observer!==v)return!0;const e=new Set(t._outputs);for(const i of e){if(i._observer!==v)return!0;i._outputs.forEach(e.add,e)}return!1}function St(t){return globalThis[t]}export{xt as Inspector,kt as Library,z as Runtime,c as RuntimeError};
