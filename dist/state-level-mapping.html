<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="generator" content="Observable Framework v1.13.0">
<title>State Level Mapping | Measurement By Design</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preload" as="style" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="preload" as="style" href="./_observablehq/theme-air,near-midnight.dcdbf18e.css">
<link rel="preload" as="style" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css2?family=Source+Serif+4:ital,opsz,wght@0,8..60,200..900;1,8..60,200..900&amp;display=swap" crossorigin>
<link rel="stylesheet" type="text/css" href="./_observablehq/theme-air,near-midnight.dcdbf18e.css">
<link rel="stylesheet" type="text/css" href="./_observablehq/stdlib/inputs.ea9fd553.css">
<link rel="modulepreload" href="./_observablehq/client.11aa6b6e.js">
<link rel="modulepreload" href="./_observablehq/runtime.9393ab6d.js">
<link rel="modulepreload" href="./_observablehq/stdlib.95bfbf7e.js">
<link rel="modulepreload" href="./_import/components/map-utilities.d0ce8f24.js">
<link rel="modulepreload" href="./_observablehq/stdlib/inputs.d397b6a8.js">
<link rel="modulepreload" href="./_npm/@observablehq/plot@0.6.16/e828d8c8.js">
<link rel="modulepreload" href="./_npm/topojson-client@3.1.0/44d97fcb.js">
<link rel="modulepreload" href="./_npm/d3-dsv@3.0.1/407f7a1f.js">
<link rel="modulepreload" href="./_npm/htl@0.3.1/063eb405.js">
<link rel="modulepreload" href="./_npm/isoformat@0.2.1/c68fbd73.js">
<link rel="modulepreload" href="./_npm/d3@7.9.0/7055d4c5.js">
<link rel="modulepreload" href="./_npm/interval-tree-1d@1.0.4/a62ae5ce.js">
<link rel="modulepreload" href="./_npm/d3-array@3.2.4/e95f898e.js">
<link rel="modulepreload" href="./_npm/d3-axis@3.0.0/d44feff9.js">
<link rel="modulepreload" href="./_npm/d3-brush@3.0.0/5830b12a.js">
<link rel="modulepreload" href="./_npm/d3-chord@3.0.1/84d7b8e9.js">
<link rel="modulepreload" href="./_npm/d3-color@3.1.0/2c0cdfa2.js">
<link rel="modulepreload" href="./_npm/d3-contour@4.0.2/626bedc4.js">
<link rel="modulepreload" href="./_npm/d3-delaunay@6.0.4/00c41b5d.js">
<link rel="modulepreload" href="./_npm/d3-dispatch@3.0.1/b5f7cdc6.js">
<link rel="modulepreload" href="./_npm/d3-drag@3.0.0/b22c5864.js">
<link rel="modulepreload" href="./_npm/d3-ease@3.0.1/6f15f633.js">
<link rel="modulepreload" href="./_npm/d3-fetch@3.0.1/ef1ec490.js">
<link rel="modulepreload" href="./_npm/d3-force@3.0.0/5e1ff060.js">
<link rel="modulepreload" href="./_npm/d3-format@3.1.0/5851d7ef.js">
<link rel="modulepreload" href="./_npm/d3-geo@3.1.1/dcd02767.js">
<link rel="modulepreload" href="./_npm/d3-hierarchy@3.1.2/f1db2593.js">
<link rel="modulepreload" href="./_npm/d3-interpolate@3.0.1/034b7bcb.js">
<link rel="modulepreload" href="./_npm/d3-path@3.1.0/4bb53638.js">
<link rel="modulepreload" href="./_npm/d3-polygon@3.0.1/bbafde58.js">
<link rel="modulepreload" href="./_npm/d3-quadtree@3.0.1/aa5b35a8.js">
<link rel="modulepreload" href="./_npm/d3-random@3.0.1/32c7fec2.js">
<link rel="modulepreload" href="./_npm/d3-scale@4.0.2/567840a0.js">
<link rel="modulepreload" href="./_npm/d3-scale-chromatic@3.1.0/cf9b720b.js">
<link rel="modulepreload" href="./_npm/d3-selection@3.0.0/5dcd62f4.js">
<link rel="modulepreload" href="./_npm/d3-shape@3.2.0/f8e03c56.js">
<link rel="modulepreload" href="./_npm/d3-time@3.1.0/5bc129e1.js">
<link rel="modulepreload" href="./_npm/d3-time-format@4.1.0/19c92b44.js">
<link rel="modulepreload" href="./_npm/d3-timer@3.0.1/f31b5398.js">
<link rel="modulepreload" href="./_npm/d3-transition@3.0.1/8debb4ba.js">
<link rel="modulepreload" href="./_npm/d3-zoom@3.0.0/4b0cc581.js">
<link rel="modulepreload" href="./_npm/binary-search-bounds@2.0.5/1ee6c50d.js">
<link rel="modulepreload" href="./_npm/internmap@2.0.3/5eed35fd.js">
<link rel="modulepreload" href="./_npm/delaunator@5.0.1/e67acb27.js">
<link rel="modulepreload" href="./_npm/robust-predicates@3.0.2/8ac9039b.js">
<script type="module">

import {define} from "./_observablehq/client.11aa6b6e.js";
import {registerFile} from "./_observablehq/stdlib.95bfbf7e.js";

registerFile("./data/BRFSS__Table_of_Overweight_and_Obesity__BMI__20241118.csv", {"name":"./data/BRFSS__Table_of_Overweight_and_Obesity__BMI__20241118.csv","mimeType":"text/csv","path":"./_file/data/BRFSS__Table_of_Overweight_and_Obesity__BMI__20241118.74bcf5f9.csv","lastModified":1732311158047,"size":27513298});
registerFile("./data/state-centers.csv", {"name":"./data/state-centers.csv","mimeType":"text/csv","path":"./_file/data/state-centers.b52454af.csv","lastModified":1732311153687,"size":1845});
registerFile("./data/us-counties-10m.json", {"name":"./data/us-counties-10m.json","mimeType":"application/json","path":"./_file/data/us-counties-10m.145aaf5d.json","lastModified":1732311287187,"size":842143});

define({id: "f99fedc0", outputs: ["d3","calculateCentroid"], body: async () => {
const [d3, {calculateCentroid}] = await Promise.all([import("https://cdn.jsdelivr.net/npm/d3@7/+esm"), import("./_import/components/map-utilities.d0ce8f24.js")]);
// import d3.js

return {d3,calculateCentroid};
}});

define({id: "1eca00a8", inputs: ["FileAttachment"], outputs: ["us"], body: (FileAttachment) => {
// Pull in geojson data
const us = FileAttachment("./data/us-counties-10m.json").json()
return {us};
}});

define({id: "9bbbbb7d", inputs: ["topojson","us"], outputs: ["states","nation"], body: (topojson,us) => {
const states = topojson.feature(us, us.objects.states)
const nation = topojson.feature(us, us.objects.nation)
return {states,nation};
}});

define({id: "fd9054f5", inputs: ["FileAttachment"], outputs: ["state_centers"], body: async (FileAttachment) => {
const state_centers = await FileAttachment("./data/state-centers.csv").csv({
  typed: true,
})
return {state_centers};
}});

define({id: "a442ec5f", inputs: ["FileAttachment"], outputs: ["obesity_data"], body: async (FileAttachment) => {
const obesity_data = await FileAttachment(
  "./data/BRFSS__Table_of_Overweight_and_Obesity__BMI__20241118.csv"
).csv({ typed: true })
return {obesity_data};
}});

define({id: "dde4d4cf", inputs: ["obesity_data"], outputs: ["uniqueBreak_Out_Category","uniqueBreak_Out","uniqueYear"], body: (obesity_data) => {
// create unique list of breakouts categories.
const uniqueBreak_Out_Category = Array.from(
  new Set(obesity_data.map((d) => d["Break_Out_Category"]))
)
// create unique list of breakouts.
const uniqueBreak_Out = Array.from(
  new Set(obesity_data.map((d) => d["Break_Out"]))
)

// create unique list of years.
const uniqueYear = Array.from(new Set(obesity_data.map((d) => d["Year"])))
return {uniqueBreak_Out_Category,uniqueBreak_Out,uniqueYear};
}});

define({id: "108f824b", inputs: ["obesity_data","B_O_C"], outputs: ["getUniqueResponses","currentResponses"], body: (obesity_data,B_O_C) => {
// function to return response conditional on break out category selection
function getUniqueResponses(selectedBreakOutCategory) {
  return Array.from(
    new Set(
      obesity_data
        .filter((d) => d["Break_Out_Category"] === selectedBreakOutCategory)
        .map((d) => d["Response"])
    )
  )
}

// Initial Responses
const currentResponses = getUniqueResponses(B_O_C)
return {getUniqueResponses,currentResponses};
}});

define({id: "4f4acdfe", inputs: ["obesity_data","B_O_C","Y_S","R_S","B_O","state_centers","d3"], outputs: ["filteredData","prevalenceByState","prevalenceExtent","colorScale"], body: (obesity_data,B_O_C,Y_S,R_S,B_O,state_centers,d3) => {
const filteredData = obesity_data
  .filter(
    (d) =>
      d["Break_Out_Category"] === B_O_C &&
      d["Year"] === Y_S &&
      d["Response"] === R_S &&
      d["Break_Out"] === B_O
  ) // filter based on selections
  .map((d) => ({
    state: d["Locationdesc"],
    prevalence: parseFloat(d["Data_value"]),
    race: d["Break_Out"],
    response: d["Response"],
  })) // remap data to give common sense categories.
  .map((d) => {
    const geo = state_centers.find(
      (state) => state.name.toLowerCase() === d.state.toLowerCase()
    ) // join state center data and make things uniform to match

    // Log unmatched states
    if (!geo) {
      console.warn(`No geolocation found for state: ${d.state}`)
    }

    // return mapped data with two lat long
    // impute nulls where state data isn't available
    return {
      ...d,
      latitude: geo ? geo.latitude : null,
      longitude: geo ? geo.longitude : null,
    }
  })

// Convert to a map for easier lookup
// this isn't strictly neccessary, but helps with color mapping
const prevalenceByState = new Map(
  filteredData.map((d) => [d.state, d.prevalence])
)

// create color scale
// TODO(harmonize color scale across quantiles instead of extent)
const prevalenceExtent = d3.extent(filteredData, (d) => d.prevalence)
// create quantized colorscale
const colorScale = d3
  .scaleQuantize()
  .domain(prevalenceExtent)
  .range(d3.schemeBlues[9])
return {filteredData,prevalenceByState,prevalenceExtent,colorScale};
}});

define({id: "493b5700", inputs: ["d3","filteredData","x_force","y_force","radius"], outputs: ["projection","labelData","checkOverlap","overlappingLabels","simulation"], body: (d3,filteredData,x_force,y_force,radius) => {
// Create projection
const projection = d3.geoAlbersUsa().scale(1300).translate([600, 300])

// Create label data with more realistic text dimensions
const labelData = filteredData
  .map((d) => {
    const projected = projection([d.longitude, d.latitude])
    if (!projected) return null

    // Calculate actual text width based on content
    // Approximate 8px per character
    const textWidth = `${d.prevalence.toFixed(1)}%`.length * 8

    return {
      x: projected[0],
      y: projected[1],
      text: `${d.prevalence.toFixed(1)}%`,
      originalX: projected[0],
      originalY: projected[1],
      state: d.state,
      longitude: d.longitude,
      latitude: d.latitude,
      width: textWidth + 10,
      height: 20,
    }
  })
  .filter((d) => d !== null) // handle nulls

// More precise overlap detection
function checkOverlap(a, b) {
  const buffer = 50 // Additional spacing between labels
  return (
    Math.abs(a.x - b.x) < (a.width + b.width) / 2 + buffer &&
    Math.abs(a.y - b.y) < (a.height + b.height) / 2 + buffer
  )
}

// Find overlapping labels
const overlappingLabels = new Set()
labelData.forEach((label, i) => {
  labelData.slice(i + 1).forEach((otherLabel) => {
    if (checkOverlap(label, otherLabel)) {
      overlappingLabels.add(label)
      overlappingLabels.add(otherLabel)
    }
  })
})

// Force simulation only for overlapping labels
const simulation = d3
  .forceSimulation([...overlappingLabels])
  .force("x", d3.forceX((d) => d.originalX).strength(x_force))
  .force("y", d3.forceY((d) => d.originalY).strength(y_force))
  .force("collision", d3.forceCollide().radius(radius))
  .stop()

for (let i = 0; i < 50; i++) simulation.tick()

// Update positions
labelData.forEach((label) => {
  if (overlappingLabels.has(label)) {
    label.vx = label.x - label.originalX
    label.vy = label.y - label.originalY
  } else {
    label.vx = 0
    label.vy = 0
  }
})
return {projection,labelData,checkOverlap,overlappingLabels,simulation};
}});

define({id: "bf2dcbcd", inputs: ["view","Inputs","uniqueBreak_Out_Category","uniqueBreak_Out","d3","uniqueYear"], outputs: ["B_O_C","B_O","Y_S"], body: (view,Inputs,uniqueBreak_Out_Category,uniqueBreak_Out,d3,uniqueYear) => {
const B_O_C = view(
  Inputs.select(uniqueBreak_Out_Category, {
    value: "Race/Ethnicity",
    label: "Break Out Category",
  })
)

const B_O = view(
  Inputs.select(uniqueBreak_Out, {
    value: "White, non-Hispanic",
    label: "Break Out",
  })
)

const Y_S = view(
  //[2011,2023]
  Inputs.range(d3.extent(uniqueYear), {
    value: 2023,
    step: 1,
    label: "Year",
    format: (year) => year.toString(),
  })
)
return {B_O_C,B_O,Y_S};
}});

define({id: "a9c50de7", inputs: ["view","Inputs","currentResponses"], outputs: ["R_S","radius","x_force","y_force","toggle_on"], body: (view,Inputs,currentResponses) => {
// Visualize response
const R_S = view(
  Inputs.select(currentResponses, {
    label: "Response",
  })
)
const radius = view(
  Inputs.range([0, 100], { label: "influence radius", step: 0.1, value: 2 })
)
const x_force = view(Inputs.range([0, 1], { label: "x force ", step: 0.05 }))
const y_force = view(Inputs.range([0, 1], { label: "y force ", step: 0.05 }))
const toggle_on = view(Inputs.select([0, 1], { label: "Toggle Labels " }))
return {R_S,radius,x_force,y_force,toggle_on};
}});

define({id: "fd741a75", inputs: ["Plot","projection","nation","states","prevalenceByState","colorScale","labelData","view"], outputs: ["chart"], body: (Plot,projection,nation,states,prevalenceByState,colorScale,labelData,view) => {
const chart = Plot.plot({
  projection: projection,
  height: 600,
  width: 1200,
  style: {
    fontSize: 12,
  },
  marks: [
    Plot.geo(nation, { stroke: "black", strokeOpacity: 0.5 }),
    Plot.geo(states, {
      stroke: "black",
      strokeOpacity: 0.5,
      fill: (d) => {
        const prevalence = prevalenceByState.get(d.properties.name)
        return prevalence != null ? colorScale(prevalence) : "#ccc"
      },
    }),
    // Plot.dot(labelData, {
    //   x: d => d.longitude + d.vx,
    //   y: d => d.latitude + d.vy,
    //   r: 2,
    //   fill: "red",
    //   title: d => d.state
    // }),
    Plot.text(labelData, {
      x: (d) => d.longitude + d.vx / 1.1,
      y: (d) => d.latitude + d.vy / 1.1,
      text: (d) => d.text,
      fill: "yellow",
      stroke: "black",
      fontSize: 15,
      strokeWidth: 3,
      title: (d) => d.state,
    }),
    Plot.arrow(
      labelData.filter((d) => d.vx !== 0 || d.vy !== 0),
      {
        x2: (d) => d.longitude + d.vx / 1.4,
        y2: (d) => d.latitude + d.vy / 1.4,
        x1: (d) => d.longitude,
        y1: (d) => d.latitude,
        headLength: 2,
        stroke: "orange",
      }
    ),
  ],
})

view(chart)
return {chart};
}});

define({id: "a8f3e61e", inputs: ["view","Inputs","obesity_data"], outputs: ["macMapping","getMACOptions","selectedMACs","validData","selectedCategory"], body: (view,Inputs,obesity_data) => {
const macMapping = new Map([
  ["Alabama", { mac: "Palmetto GBA", jurisdiction: "J10", abbr: "AL" }],
  [
    "Alaska",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J2", abbr: "AK" },
  ],
  [
    "Arizona",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J3", abbr: "AZ" },
  ],
  ["Arkansas", { mac: "Novitas Solutions", jurisdiction: "J7", abbr: "AR" }],
  [
    "California",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J1", abbr: "CA" },
  ],
  ["Colorado", { mac: "Novitas Solutions", jurisdiction: "J4", abbr: "CO" }],
  [
    "Connecticut",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J13",
      abbr: "CT",
    },
  ],
  ["Delaware", { mac: "Novitas Solutions", jurisdiction: "J12", abbr: "DE" }],
  [
    "District of Columbia",
    { mac: "Novitas Solutions", jurisdiction: "J12", abbr: "DC" },
  ],
  [
    "Florida",
    { mac: "First Coast Service Options", jurisdiction: "J9", abbr: "FL" },
  ],
  ["Georgia", { mac: "Palmetto GBA", jurisdiction: "J10", abbr: "GA" }],
  [
    "Hawaii",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J1", abbr: "HI" },
  ],
  [
    "Idaho",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J2", abbr: "ID" },
  ],
  [
    "Illinois",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J6",
      abbr: "IL",
    },
  ],
  [
    "Indiana",
    {
      mac: "Wisconsin Physicians Service (WPS)",
      jurisdiction: "J8",
      abbr: "IN",
    },
  ],
  [
    "Iowa",
    {
      mac: "Wisconsin Physicians Service (WPS)",
      jurisdiction: "J5",
      abbr: "IA",
    },
  ],
  [
    "Kansas",
    {
      mac: "Wisconsin Physicians Service (WPS)",
      jurisdiction: "J5",
      abbr: "KS",
    },
  ],
  ["Kentucky", { mac: "CGS Administrators", jurisdiction: "J15", abbr: "KY" }],
  ["Louisiana", { mac: "Novitas Solutions", jurisdiction: "J7", abbr: "LA" }],
  [
    "Maine",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J14",
      abbr: "ME",
    },
  ],
  ["Maryland", { mac: "Novitas Solutions", jurisdiction: "J12", abbr: "MD" }],
  [
    "Massachusetts",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J14",
      abbr: "MA",
    },
  ],
  [
    "Michigan",
    {
      mac: "Wisconsin Physicians Service (WPS)",
      jurisdiction: "J8",
      abbr: "MI",
    },
  ],
  [
    "Minnesota",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J6",
      abbr: "MN",
    },
  ],
  ["Mississippi", { mac: "Novitas Solutions", jurisdiction: "J7", abbr: "MS" }],
  [
    "Missouri",
    {
      mac: "Wisconsin Physicians Service (WPS)",
      jurisdiction: "J5",
      abbr: "MO",
    },
  ],
  [
    "Montana",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J3", abbr: "MT" },
  ],
  [
    "Nebraska",
    {
      mac: "Wisconsin Physicians Service (WPS)",
      jurisdiction: "J5",
      abbr: "NE",
    },
  ],
  [
    "Nevada",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J1", abbr: "NV" },
  ],
  [
    "New Hampshire",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J14",
      abbr: "NH",
    },
  ],
  ["New Jersey", { mac: "Novitas Solutions", jurisdiction: "J12", abbr: "NJ" }],
  ["New Mexico", { mac: "Novitas Solutions", jurisdiction: "J4", abbr: "NM" }],
  [
    "New York",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J13",
      abbr: "NY",
    },
  ],
  ["North Carolina", { mac: "Palmetto GBA", jurisdiction: "J11", abbr: "NC" }],
  [
    "North Dakota",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J3", abbr: "ND" },
  ],
  ["Ohio", { mac: "CGS Administrators", jurisdiction: "J15", abbr: "OH" }],
  ["Oklahoma", { mac: "Novitas Solutions", jurisdiction: "J4", abbr: "OK" }],
  [
    "Oregon",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J2", abbr: "OR" },
  ],
  [
    "Pennsylvania",
    { mac: "Novitas Solutions", jurisdiction: "J12", abbr: "PA" },
  ],
  [
    "Rhode Island",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J14",
      abbr: "RI",
    },
  ],
  ["South Carolina", { mac: "Palmetto GBA", jurisdiction: "J11", abbr: "SC" }],
  [
    "South Dakota",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J3", abbr: "SD" },
  ],
  ["Tennessee", { mac: "Palmetto GBA", jurisdiction: "J10", abbr: "TN" }],
  ["Texas", { mac: "Novitas Solutions", jurisdiction: "J4", abbr: "TX" }],
  [
    "Utah",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J3", abbr: "UT" },
  ],
  [
    "Vermont",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J14",
      abbr: "VT",
    },
  ],
  ["Virginia", { mac: "Palmetto GBA", jurisdiction: "J11", abbr: "VA" }],
  [
    "Washington",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J2", abbr: "WA" },
  ],
  ["West Virginia", { mac: "Palmetto GBA", jurisdiction: "J11", abbr: "WV" }],
  [
    "Wisconsin",
    {
      mac: "National Government Services (NGS)",
      jurisdiction: "J6",
      abbr: "WI",
    },
  ],
  [
    "Wyoming",
    { mac: "Noridian Healthcare Solutions", jurisdiction: "J3", abbr: "WY" },
  ],
])

const getMACOptions = () => {
  const jurisdictionStates = {}

  Array.from(macMapping.values()).forEach(({ jurisdiction, abbr }) => {
    if (!jurisdictionStates[jurisdiction]) {
      jurisdictionStates[jurisdiction] = []
    }
    jurisdictionStates[jurisdiction].push(abbr)
  })

  return Object.entries(jurisdictionStates)
    .sort((a, b) => {
      const numA = parseInt(a[0].substring(1))
      const numB = parseInt(b[0].substring(1))
      return numA - numB
    })
    .map(([j, states]) => `${j}: ${states.sort().join(", ")}`)
}

const selectedMACs = view(
  Inputs.select(getMACOptions(), {
    label: "Medicare Administrative Contractors (MACs)",
    value: ["J3: WY, ND, MT, SD"],
    multiple: true,
  })
)

const validData = obesity_data.filter(
  (d) =>
    d.Data_value !== null &&
    !d.Data_Value_Footnote_Symbol &&
    d.Sample_Size >= 50
)

const selectedCategory = view(
  Inputs.select(
    Array.from(new Set(validData.map((d) => d.Break_Out_Category))),
    {
      label: "Break Out Category",
      value: "Overall",
    }
  )
)
return {macMapping,getMACOptions,selectedMACs,validData,selectedCategory};
}});

define({id: "4bf7698d", inputs: ["view","Inputs","selectedCategory","obesity_data"], outputs: ["selectedBreakouts","getUniqueResponses","selectedResponses"], body: (view,Inputs,selectedCategory,obesity_data) => {
const selectedBreakouts = view(
  Inputs.select(
    selectedCategory === "Overall"
      ? ["Overall"]
      : Array.from(
          new Set(
            obesity_data
              .filter((d) => d.Break_Out_Category === selectedCategory)
              .map((d) => d.Break_Out)
          )
        ),
    {
      label: "Break Out",
      multiple: true,
      value: selectedCategory === "Overall" ? ["Overall"] : ["18-24", "25-34"],
    }
  )
)
const getUniqueResponses = () => {
  return Array.from(
    new Set(obesity_data.map((d) => d.Response).map((r) => r.toLowerCase()))
  ).map(
    (r) => obesity_data.find((d) => d.Response.toLowerCase() === r).Response
  ) // Get original casing
}

const selectedResponses = view(
  Inputs.select(getUniqueResponses(), {
    label: "Response",
    multiple: true,
    value: ["Obese (BMI 30.0 - 99.8)"],
  })
)
return {selectedBreakouts,getUniqueResponses,selectedResponses};
}});

define({id: "70ff166a", inputs: ["selectedMACs","obesity_data","macMapping","selectedCategory","selectedBreakouts","selectedResponses","d3","view","Plot"], outputs: ["getJurisdictionFromOption","getSelectedJurisdictions","plotData","getLegendLabel","summaryData","legendLabels","breakoutColors","plot"], body: (selectedMACs,obesity_data,macMapping,selectedCategory,selectedBreakouts,selectedResponses,d3,view,Plot) => {
// Helper function to extract jurisdiction code from MAC option
const getJurisdictionFromOption = (option) => option.split(":")[0]

// Helper function to extract jurisdictions from selected MAC options
const getSelectedJurisdictions = () =>
  selectedMACs.map((mac) => getJurisdictionFromOption(mac))

const plotData = obesity_data
  .filter((d) => {
    const stateInfo = macMapping.get(d.Locationdesc)
    return (
      stateInfo && getSelectedJurisdictions().includes(stateInfo.jurisdiction)
    )
  })
  .filter((d) => d.Break_Out_Category === selectedCategory)
  .filter(
    (d) =>
      selectedCategory === "Overall" || selectedBreakouts.includes(d.Break_Out)
  )
  .filter((d) => selectedResponses.includes(d.Response))
  .map((d) => ({
    year: d.Year,
    state: d.Locationdesc,
    value: d.Data_value,
    ci_low: d.Confidence_limit_Low,
    ci_high: d.Confidence_limit_High,
    response: d.Response,
    breakout: selectedCategory === "Overall" ? "Overall" : d.Break_Out,
    category: d.Break_Out_Category,
    jurisdiction: macMapping.get(d.Locationdesc).jurisdiction,
    stateAbbr: macMapping.get(d.Locationdesc).abbr,
  }))
  .filter((d) => d.value != null)

const getLegendLabel = (d) => {
  const jurisdictions = Array.from(
    new Set(
      plotData
        .filter((p) => p.breakout === d.breakout && p.response === d.response)
        .map((p) => p.jurisdiction)
    )
  )
    .sort()
    .join(", ")
  return `${d.response}, ${d.breakout} (${jurisdictions})`
}

// Calculate summary statistics
const summaryData = Array.from(
  d3.group(
    plotData,
    (d) => d.year,
    (d) => d.breakout,
    (d) => d.response
  )
)
  .map(([year, breakouts]) =>
    Array.from(breakouts).map(([breakout, responses]) =>
      Array.from(responses).map(([response, values]) => ({
        year: +year,
        breakout,
        response,
        mean: d3.mean(values, (d) => d.value),
        ci_low: d3.mean(values, (d) => d.ci_low),
        ci_high: d3.mean(values, (d) => d.ci_high),
      }))
    )
  )
  .flat(2)

view(summaryData)
// Create ordered unique legend labels
const legendLabels = Array.from(
  new Set(
    plotData.map((d) => {
      const jurisdictions = Array.from(
        new Set(
          plotData
            .filter(
              (p) => p.breakout === d.breakout && p.response === d.response
            )
            .map((p) => p.jurisdiction)
        )
      )
        .sort()
        .join(", ")
      return `${d.response}, ${d.breakout} (${jurisdictions})`
    })
  )
).sort()

const breakoutColors = d3
  .scaleOrdinal()
  .domain(legendLabels)
  .range(d3.schemeTableau10)

const plot = Plot.plot({
  height: 300,
  width: 1000,
  marginLeft: 60,
  grid: true,
  x: {
    label: "Year",
    tickFormat: (d) => d.toString(),
  },
  y: {
    label: "Prevalence (%)",
    domain: [0, 100],
  },
  color: {
    legend: true,
    domain: legendLabels,
  },
  marks: [
    Plot.line(plotData, {
      x: "year",
      y: "value",
      stroke: (d) => breakoutColors(getLegendLabel(d)),
      strokeOpacity: 0.1,
      z: (d) => `${d.state}_${getLegendLabel(d)}`,
    }),
    Plot.ruleY([0]),
    Plot.line(summaryData, {
      x: "year",
      y: "mean",
      stroke: (d) => breakoutColors(getLegendLabel(d)),
      strokeWidth: 2,
      z: (d) => getLegendLabel(d),
    }),
    Plot.areaY(summaryData, {
      x: "year",
      y1: "ci_low",
      y2: "ci_high",
      fill: (d) => breakoutColors(getLegendLabel(d)),
      fillOpacity: 0.2,
      z: (d) => getLegendLabel(d),
    }),
  ],
})

view(plot)
return {getJurisdictionFromOption,getSelectedJurisdictions,plotData,getLegendLabel,summaryData,legendLabels,breakoutColors,plot};
}});

</script>
</head>
<body>
<input id="observablehq-sidebar-toggle" type="checkbox" title="Toggle sidebar">
<label id="observablehq-sidebar-backdrop" for="observablehq-sidebar-toggle"></label>
<nav id="observablehq-sidebar">
  <ol>
    <label id="observablehq-sidebar-close" for="observablehq-sidebar-toggle"></label>
    <li class="observablehq-link"><a href="./">Measurement By Design</a></li>
  </ol>
  <ol>
    <li class="observablehq-link"><a href="./">Overview Dashboard</a></li>
  </ol>
  <details open>
    <summary>Imaging</summary>
    <ol>
    <li class="observablehq-link"><a href="./value-framing">Problem Definition</a></li>
    <li class="observablehq-link"><a href="./EDA-ROI">EDA &amp; ROI</a></li>
    <li class="observablehq-link"><a href="./hypothesis">Hypothesis</a></li>
    <li class="observablehq-link"><a href="./targeting">Targeting Strategy</a></li>
    <li class="observablehq-link"><a href="./exp-design">Experimental Design</a></li>
    </ol>
  </details>
  <details open class="observablehq-section-active">
    <summary>Primitive Assets</summary>
    <ol>
    <li class="observablehq-link observablehq-link-active"><a href="./state-level-mapping">BRFSS State Level Mapping</a></li>
    <li class="observablehq-link"><a href="./exp-design-figures">Experimental Design Figures</a></li>
    <li class="observablehq-link"><a href="./live-table-data">Live Table</a></li>
    <li class="observablehq-link"><a href="./distp-demo">Distribution Demo</a></li>
    <li class="observablehq-link"><a href="./funnel-chart">Funnel Chart</a></li>
    <li class="observablehq-link"><a href="./intervention-design">Intervention Design</a></li>
    <li class="observablehq-link"><a href="./random-forest">In Browser Random Forests</a></li>
    <li class="observablehq-link"><a href="./mass-balance-business-models">Mass Balance Business Models</a></li>
    <li class="observablehq-link"><a href="./experimental-design">Simple Experimental Design</a></li>
    <li class="observablehq-link"><a href="./microsite">Microsite Demo</a></li>
    <li class="observablehq-link"><a href="./collapsible-cell">Collapsible Cell</a></li>
    </ol>
  </details>
</nav>
<script>{const e=document.querySelector("#observablehq-sidebar"),t=document.querySelector("#observablehq-sidebar-toggle"),r=sessionStorage.getItem("observablehq-sidebar");r?t.checked=r==="true":t.indeterminate=!0;for(const o of document.querySelectorAll("#observablehq-sidebar summary")){const s=o.parentElement;switch(sessionStorage.getItem(`observablehq-sidebar:${o.textContent}`)){case"true":s.open=!0;break;case"false":s.classList.contains("observablehq-section-active")||(s.open=!1);break}}addEventListener("beforeunload",()=>sessionStorage.setItem("observablehq-sidebar-scrolly",`${e.scrollTop}`));const a=sessionStorage.getItem("observablehq-sidebar-scrolly");a!=null&&(e.style.cssText="overflow: hidden;",e.scrollTop=+a,e.style.cssText="");}</script>
<div id="observablehq-center">
<aside id="observablehq-toc" data-selector="h1:not(:first-of-type)[id], h2:first-child[id], :not(h1) + h2[id]">
<nav>
<div>Contents</div>
<ol>
<li class="observablehq-secondary-link"><a href="#time-series-view">Time series view</a></li>
</ol>
</nav>
</aside>
<main id="observablehq-main" class="observablehq">
<h1 id="chronic-disease-in-america" tabindex="-1"><a class="observablehq-header-anchor" href="#chronic-disease-in-america">Chronic Disease in America</a></h1>
<p>Chronic disease in America is fairly well tracked by the CDC and the BRFSS. Let's make a little live plot to demonstrate.</p>
<div class="observablehq observablehq--block"><!--:f99fedc0:--></div>
<p>Steps:</p>
<ol>
<li>Pull in geojson data</li>
</ol>
<div class="observablehq observablehq--block"><!--:1eca00a8:--></div>
<ol start="2">
<li>Split it up into states and nations to control visibility for both.</li>
</ol>
<div class="observablehq observablehq--block"><!--:9bbbbb7d:--></div>
<ol start="3">
<li>Find the <a href="https://developers.google.com/public-data/docs/canonical/states_csv" target="_blank" rel="noopener noreferrer">centroids for each state</a>. This is common, so google has helped us out a bit.</li>
</ol>
<div class="observablehq observablehq--block"><!--:fd9054f5:--></div>
<ol start="3">
<li>Bring in the BRFSS Data.</li>
</ol>
<div class="observablehq observablehq--block"><!--:a442ec5f:--></div>
<ol start="4">
<li>Create unique list of breakouts categories, breakouts and years.</li>
</ol>
<div class="observablehq observablehq--block"><!--:dde4d4cf:--></div>
<ol start="5">
<li>
<p>Create selection views to solicit selection of breakout category, breakout, and year to visualize. These will be visualized ensemble with other selections, but calculated here.</p>
</li>
<li>
<p>Based on the selection, dynamically return the responses. Then select response to be visualized.</p>
</li>
</ol>
<div class="observablehq observablehq--block"><!--:108f824b:--></div>
<ol start="7">
<li>Filter the data to <em>just</em> what's needed to visualize. Map and prep data for plotting with conditional selections. Create color scale for choropleth.</li>
</ol>
<div class="observablehq observablehq--block"><!--:4f4acdfe:--></div>
<ol start="8">
<li>Force simulate to prevent overlaps with some constraints. This isn't strictly neccessary, but is a nice touch. Do it once and you've got a nice template to do it in the future.</li>
</ol>
<div class="observablehq observablehq--block"><!--:493b5700:--></div>
<ol start="9">
<li>View selections.</li>
</ol>
<div class="observablehq observablehq--block"><!--:bf2dcbcd:--></div>
<div class="observablehq observablehq--block"><!--:a9c50de7:--></div>
<ol start="10">
<li>Plot!</li>
</ol>
<div class="observablehq observablehq--block"><!--:fd741a75:--></div>
<h2 id="time-series-view" tabindex="-1"><a class="observablehq-header-anchor" href="#time-series-view">Time series view</a></h2>
<div class="observablehq observablehq--block"><!--:a8f3e61e:--></div>
<div class="observablehq observablehq--block"><!--:4bf7698d:--></div>
<div class="observablehq observablehq--block"><!--:70ff166a:--></div>
</main>
<footer id="observablehq-footer">
<nav><a rel="prev" href="./exp-design"><span>Experimental Design</span></a><a rel="next" href="./exp-design-figures"><span>Experimental Design Figures</span></a></nav>
<div>Built with <a href="https://observablehq.com/" target="_blank" rel="noopener noreferrer">Observable</a> on <a title="2024-12-05T02:25:39">Dec 5, 2024</a>.</div>
</footer>
</div>
</body>
</html>
